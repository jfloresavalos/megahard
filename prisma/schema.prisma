generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Sede {
  id                   String            @id @default(cuid())
  nombre               String            @unique
  direccion            String
  telefono             String?
  activo               Boolean           @default(true)
  createdAt            DateTime          @default(now())
  movimientosStock     MovimientoStock[]
  productos            ProductoSede[]
  servicios            ServicioTecnico[]
  usuarios             Usuario[]
  ventas               Venta[]
  traspasosEnviados    MovimientoStock[] @relation("TraspasosOrigen")
  traspasosRecibidos   MovimientoStock[] @relation("TraspasosDestino")
}

model Usuario {
  id                   String              @id @default(cuid())
  nombre               String
  email                String?             @unique
  password             String
  rol                  String              @default("supervisor")
  sedeId               String?
  activo               Boolean             @default(true)
  createdAt            DateTime            @default(now())
  username             String?             @unique @db.VarChar(255)
  actividades          ActividadUsuario[]
  servicios            ServicioTecnico[]
  sede                 Sede?               @relation(fields: [sedeId], references: [id])
  ventas               Venta[]
  historialServicios   ServicioHistorial[]
  movimientosCreados   MovimientoStock[]   @relation("MovimientosUsuario")
  movimientosRecibidos MovimientoStock[]   @relation("MovimientosRecepcion")
  movimientosAnulados  MovimientoStock[]   @relation("MovimientosAnulados")
  importaciones        HistorialImportacion[]
}

model ActividadUsuario {
  id          String   @id @default(cuid())
  usuarioId   String
  accion      String
  descripcion String
  fecha       DateTime @default(now())
  usuario     Usuario  @relation(fields: [usuarioId], references: [id])
}

model Categoria {
  id            String         @id @default(cuid())
  nombre        String         @unique
  descripcion   String?
  activo        Boolean        @default(true)
  createdAt     DateTime       @default(now())
  subcategorias Subcategoria[]
}

model Subcategoria {
  id          String     @id @default(cuid())
  nombre      String
  categoriaId String
  activo      Boolean    @default(true)
  productos   Producto[]
  categoria   Categoria  @relation(fields: [categoriaId], references: [id])

  @@unique([categoriaId, nombre])
}

model Producto {
  id             String            @id @default(cuid())
  codigo         String            @unique
  nombre         String
  descripcion    String?
  garantia       String?
  precioCompra   Decimal           @db.Decimal(10, 2)
  precioVenta    Decimal           @db.Decimal(10, 2)
  stockMin       Int               @default(5)
  subcategoriaId String
  imagenes       String[]          @default([])
  activo         Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  movimientos    MovimientoStock[]
  subcategoria   Subcategoria      @relation(fields: [subcategoriaId], references: [id])
  sedes          ProductoSede[]
  servicioItems  ServicioItem[]
  ventaItems     VentaItem[]
}

model ProductoSede {
  id         String   @id @default(cuid())
  productoId String
  sedeId     String
  stock      Int      @default(0)
  updatedAt  DateTime @updatedAt
  producto   Producto @relation(fields: [productoId], references: [id])
  sede       Sede     @relation(fields: [sedeId], references: [id])

  @@unique([productoId, sedeId])
}

model MovimientoStock {
  id              String    @id @default(cuid())
  productoId      String
  sedeId          String
  tipo            String    // INGRESO, SALIDA, AJUSTE_POSITIVO, AJUSTE_NEGATIVO, TRASPASO_SALIDA, TRASPASO_ENTRADA, USO_SERVICIO, DEVOLUCION, MERMA
  cantidad        Int
  stockAntes      Int
  stockDespues    Int
  motivo          String?
  referencia      String?
  fecha           DateTime  @default(now())
  
  // Campos para anulación
  anulado         Boolean   @default(false)
  motivoAnulacion String?
  fechaAnulacion  DateTime?
  usuarioAnulaId  String?
  usuarioAnula    Usuario?  @relation("MovimientosAnulados", fields: [usuarioAnulaId], references: [id])
  
  // Campos para precios (en ingresos)
  precioCompra    Decimal?  @db.Decimal(10, 2)
  precioVenta     Decimal?  @db.Decimal(10, 2)
  
  // Usuario que creó el movimiento
  usuarioId       String?
  usuario         Usuario?  @relation("MovimientosUsuario", fields: [usuarioId], references: [id])
  
  // Campos para traspasos entre sedes
  sedeOrigenId    String?
  sedeOrigen      Sede?     @relation("TraspasosOrigen", fields: [sedeOrigenId], references: [id])
  
  sedeDestinoId   String?
  sedeDestino     Sede?     @relation("TraspasosDestino", fields: [sedeDestinoId], references: [id])
  
  // Relación bidireccional del traspaso
  traspasoRelacionadoId String?           @unique
  traspasoRelacionado   MovimientoStock?  @relation("TraspasoPareja", fields: [traspasoRelacionadoId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  traspasoInverso       MovimientoStock?  @relation("TraspasoPareja")
  
  // Estado del traspaso (PENDIENTE, EN_TRANSITO, RECIBIDO, RECHAZADO, CANCELADO)
  estadoTraspaso  String?
  fechaEnvio      DateTime?
  fechaRecepcion  DateTime?
  
  // Usuario que recibe el traspaso
  usuarioRecibeId String?
  usuarioRecibe   Usuario?  @relation("MovimientosRecepcion", fields: [usuarioRecibeId], references: [id])
  
  // Observaciones adicionales
  observaciones   String?   @db.Text
  
  // Relaciones
  producto        Producto  @relation(fields: [productoId], references: [id])
  sede            Sede      @relation(fields: [sedeId], references: [id])

  @@index([productoId])
  @@index([sedeId])
  @@index([tipo])
  @@index([anulado])
  @@index([estadoTraspaso])
  @@index([fecha])
}

model Cliente {
  id          String            @id @default(cuid())
  tipoDoc     String            @default("DNI")
  numeroDoc   String            @unique
  nombre      String
  razonSocial String?
  telefono    String?
  email       String?
  direccion   String?
  activo      Boolean           @default(true)
  createdAt   DateTime          @default(now())
  servicios   ServicioTecnico[]
  ventas      Venta[]
}

model Venta {
  id              String           @id @default(cuid())
  numeroVenta     String           @unique
  tipoComprobante String
  subtotal        Decimal          @db.Decimal(10, 2)
  total           Decimal          @db.Decimal(10, 2)
  fecha           DateTime         @default(now())
  estado          String           @default("COMPLETADA")
  motivoAnulacion String?
  clienteId       String?
  usuarioId       String
  sedeId          String
  servicioId      String?          // ✅ Relación opcional con ServicioTecnico
  cliente         Cliente?         @relation(fields: [clienteId], references: [id])
  sede            Sede             @relation(fields: [sedeId], references: [id])
  usuario         Usuario          @relation(fields: [usuarioId], references: [id])
  servicio        ServicioTecnico? @relation(fields: [servicioId], references: [id])
  items           VentaItem[]
  pagos           VentaPago[]
}

model VentaItem {
  id             String   @id @default(cuid())
  ventaId        String
  productoId     String
  cantidad       Int
  precioUnit     Decimal  @db.Decimal(10, 2)
  precioOriginal Decimal  @db.Decimal(10, 2)
  subtotal       Decimal  @db.Decimal(10, 2)
  producto       Producto @relation(fields: [productoId], references: [id])
  venta          Venta    @relation(fields: [ventaId], references: [id], onDelete: Cascade)
}

model MetodoPago {
  id     String      @id @default(cuid())
  nombre String      @unique
  activo Boolean     @default(true)
  pagos  VentaPago[]
}

model VentaPago {
  id           String     @id @default(cuid())
  ventaId      String
  metodoPagoId String
  monto        Decimal    @db.Decimal(10, 2)
  metodoPago   MetodoPago @relation(fields: [metodoPagoId], references: [id])
  venta        Venta      @relation(fields: [ventaId], references: [id], onDelete: Cascade)
}

model TipoServicio {
  id          String            @id @default(cuid())
  categoria   String
  nombre      String
  descripcion String?
  activo      Boolean           @default(true)
  servicios   ServicioTecnico[]

  @@unique([categoria, nombre])
}

model ServicioTecnico {
  id                     String              @id @default(cuid())
  numeroServicio         String
  clienteId              String
  clienteNombre          String?
  clienteDni             String?
  clienteCelular         String?
  tipoServicioId         String
  tipoEquipo             String
  marcaModelo            String?
  descripcionEquipo      String?
  descripcionProblema    String
  problemasReportados    Json?
  otrosProblemas         String?
  dejoSinCargador        Boolean             @default(false)
  dejoAccesorios         Boolean             @default(false)
  esCotizacion           Boolean             @default(false)
  faltaPernos            Boolean             @default(false)
  tieneAranaduras        Boolean             @default(false)
  otrosDetalles          String?
  diagnostico            String?
  solucion               String?
  fotosEquipo            String[]
  fotosDespues           String[]            @default([])
  estado                 String              @default("RECEPCIONADO")
  prioridad              String              @default("NORMAL")
  costoServicio          Decimal?            @db.Decimal(10, 2)
  costoRepuestos         Decimal?            @db.Decimal(10, 2)
  total                  Decimal?            @db.Decimal(10, 2)
  aCuenta                Decimal             @default(0) @db.Decimal(10, 2)
  saldo                  Decimal             @default(0) @db.Decimal(10, 2)
  serviciosAdicionales   Json?
  metodoPago             String?
  garantiaDias           Int                 @default(30)
  fechaRecepcion         DateTime            @default(now())
  fechaEntregaEstimada   DateTime?
  fechaEntregaReal       DateTime?
  usuarioId              String
  sedeId                 String
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  quienRecibeNombre      String?
  quienRecibeDni         String?
  productosVendidos      Json?
  metodoPagoSaldo        String?
  motivoCancelacion      String?
  observacionCancelacion String?
  fechaCancelacion       DateTime?
  adelantoDevuelto       Decimal?            @db.Decimal(10, 2)
  metodoDevolucion       String?
  usuarioCancelacionId   String?

  // ✅ NUEVOS CAMPOS PARA SERVICIOS A DOMICILIO
  tipoServicio           String              @default("TALLER") // "TALLER" o "DOMICILIO"
  direccionServicio      String?             // Dirección donde se realiza el servicio a domicilio

  items                  ServicioItem[]
  cliente                Cliente             @relation(fields: [clienteId], references: [id])
  sede                   Sede                @relation(fields: [sedeId], references: [id])
  tipoServicioRelacion   TipoServicio        @relation(fields: [tipoServicioId], references: [id])
  usuario                Usuario             @relation(fields: [usuarioId], references: [id])
  historial              ServicioHistorial[]
  ventas                 Venta[]             // ✅ Relación con ventas generadas al entregar

  @@unique([numeroServicio, sedeId])
  @@index([estado, fechaCancelacion])
  @@index([tipoServicio])
}

model ServicioItem {
  id         String          @id @default(cuid())
  servicioId String
  productoId String
  cantidad   Int
  precioUnit Decimal         @db.Decimal(10, 2)
  subtotal   Decimal         @db.Decimal(10, 2)
  producto   Producto        @relation(fields: [productoId], references: [id])
  servicio   ServicioTecnico @relation(fields: [servicioId], references: [id], onDelete: Cascade)
}

model ProblemaComun {
  id          String   @id @default(cuid())
  nombre      String   @unique
  descripcion String?
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
}

model ServicioAdicionalCatalogo {
  id             String   @id @default(cuid())
  nombre         String   @unique
  descripcion    String?
  precioSugerido Decimal  @default(0) @db.Decimal(10, 2)
  activo         Boolean  @default(true)
  createdAt      DateTime @default(now())
}

model ConfiguracionEmpresa {
  id            String   @id @default(cuid())
  nombreEmpresa String
  ruc           String
  eslogan       String?
  descripcion   String?
  logotipo      String?
  web           String?
  facebook      String?
  instagram     String?
  whatsapp      String?
  emailContacto String?
  metodosPago   Json?
  bancos        Json?
  numeroPlin    String?
  numeroYape    String?
  notaFooter    String?
  activo        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ServicioHistorial {
  id             String          @id @default(cuid())
  servicioId     String
  estadoAnterior String?
  estadoNuevo    String
  comentario     String?
  usuarioId      String
  fecha          DateTime        @default(now())
  servicio       ServicioTecnico @relation(fields: [servicioId], references: [id], onDelete: Cascade)
  usuario        Usuario         @relation(fields: [usuarioId], references: [id])

  @@map("servicio_historial")
}

model HistorialImportacion {
  id             String   @id @default(cuid())
  tipo           String   // 'productos', 'categorias', 'subcategorias'
  cantidad       Int      // Total de filas procesadas
  exitosos       Int      // Registros creados/actualizados exitosamente
  errores        Int      // Registros con error
  detalleErrores String?  @db.Text // JSON array con errores
  usuarioId      String?
  usuario        Usuario? @relation(fields: [usuarioId], references: [id])
  fecha          DateTime @default(now())
  
  @@index([tipo])
  @@index([fecha])
}
